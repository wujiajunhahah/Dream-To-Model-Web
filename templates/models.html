{% extends "base.html" %}

{% block title %}模型展示 - 梦境建模系统{% endblock %}

{% block content %}
<div class="models-page">
    <!-- 筛选器 -->
    <div class="filters">
        <div class="filter-group">
            <label for="category">分类</label>
            <select id="category" class="filter-select">
                <option value="">全部</option>
                <option value="architecture">建筑</option>
                <option value="character">角色</option>
                <option value="nature">自然</option>
                <option value="abstract">抽象</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="style">风格</label>
            <select id="style" class="filter-select">
                <option value="">全部</option>
                <option value="realistic">写实</option>
                <option value="cartoon">卡通</option>
                <option value="anime">动漫</option>
                <option value="lowpoly">低面数</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="sort">排序</label>
            <select id="sort" class="filter-select">
                <option value="newest">最新</option>
                <option value="popular">最受欢迎</option>
                <option value="rating">评分最高</option>
            </select>
        </div>
    </div>

    <!-- 模型网格 -->
    <div class="models-grid">
        {% for model in models %}
        <div class="model-card" data-category="{{ model.category }}" data-style="{{ model.style }}">
            <div class="model-preview">
                <model-viewer
                    src="{{ model.model_url }}"
                    alt="{{ model.name }}"
                    camera-controls
                    auto-rotate
                    shadow-intensity="1"
                    exposure="1"
                    environment-image="neutral"
                    loading="lazy">
                </model-viewer>
            </div>
            <div class="model-info">
                <h3>{{ model.name }}</h3>
                <p class="model-description">{{ model.description }}</p>
                <div class="model-meta">
                    <span class="model-category">{{ model.category }}</span>
                    <span class="model-style">{{ model.style }}</span>
                    <div class="model-rating">
                        {% for i in range(model.rating) %}
                        <i class="fas fa-star"></i>
                        {% endfor %}
                    </div>
                </div>
                <div class="model-actions">
                    <button class="btn btn-primary" onclick="previewModel('{{ model.id }}')">
                        <i class="fas fa-eye"></i> 预览
                    </button>
                    <button class="btn btn-secondary" onclick="downloadModel('{{ model.id }}')">
                        <i class="fas fa-download"></i> 下载
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 分页 -->
    <div class="pagination">
        {% if page > 1 %}
        <a href="?page={{ page - 1 }}" class="btn btn-secondary">上一页</a>
        {% endif %}
        <span class="page-info">第 {{ page }} 页</span>
        {% if has_next %}
        <a href="?page={{ page + 1 }}" class="btn btn-secondary">下一页</a>
        {% endif %}
    </div>
</div>

<!-- 模型预览模态框 -->
<div id="modelPreviewModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div class="modal-body">
            <model-viewer
                id="previewModelViewer"
                camera-controls
                auto-rotate
                shadow-intensity="1"
                exposure="1"
                environment-image="neutral">
            </model-viewer>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/**
 * 初始化筛选器
 */
function initializeFilters() {
    const filters = document.querySelectorAll('.filter-select');
    filters.forEach(filter => {
        filter.addEventListener('change', () => {
            applyFilters();
        });
    });
}

/**
 * 应用筛选条件
 */
function applyFilters() {
    const category = document.getElementById('category').value;
    const style = document.getElementById('style').value;
    const sort = document.getElementById('sort').value;
    
    const modelCards = document.querySelectorAll('.model-card');
    modelCards.forEach(card => {
        const cardCategory = card.dataset.category;
        const cardStyle = card.dataset.style;
        
        const categoryMatch = !category || cardCategory === category;
        const styleMatch = !style || cardStyle === style;
        
        card.style.display = categoryMatch && styleMatch ? 'block' : 'none';
    });
    
    // 更新URL参数
    const params = new URLSearchParams(window.location.search);
    if (category) params.set('category', category);
    if (style) params.set('style', style);
    if (sort) params.set('sort', sort);
    
    window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
}

/**
 * 预览模型
 * @param {string} modelId - 模型ID
 */
function previewModel(modelId) {
    const modal = document.getElementById('modelPreviewModal');
    const viewer = document.getElementById('previewModelViewer');
    
    // 获取模型数据
    fetch(`/api/models/${modelId}`)
        .then(response => response.json())
        .then(data => {
            viewer.src = data.model_url;
            modal.style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading model:', error);
            utils.showAlert('加载模型失败', 'error');
        });
}

/**
 * 下载模型
 * @param {string} modelId - 模型ID
 */
function downloadModel(modelId) {
    utils.showLoading(document.body);
    
    fetch(`/api/models/${modelId}/download`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `model_${modelId}.glb`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            utils.showAlert('下载成功');
        })
        .catch(error => {
            console.error('Error downloading model:', error);
            utils.showAlert('下载失败', 'error');
        })
        .finally(() => {
            utils.hideLoading(document.body);
        });
}

// 初始化模态框
document.addEventListener('DOMContentLoaded', () => {
    initializeFilters();
    
    const modal = document.getElementById('modelPreviewModal');
    const closeBtn = modal.querySelector('.close');
    
    closeBtn.onclick = () => {
        modal.style.display = 'none';
    };
    
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };
});
</script>
{% endblock %} 