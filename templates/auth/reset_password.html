{% extends "base.html" %}

{% block title %}重置密码 - 梦境建模系统{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1>重置密码</h1>
            <p>请设置您的新密码</p>
        </div>

        <!-- 重置密码表单 -->
        <form class="auth-form" method="POST" action="{{ url_for('auth.reset_password', token=token) }}">
            {{ form.csrf_token }}
            
            <div class="form-group">
                <label for="password">新密码</label>
                <div class="password-input">
                    <input type="password" id="password" name="password" required
                           placeholder="请输入新密码">
                    <button type="button" class="toggle-password" onclick="togglePassword('password')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="password-strength">
                    <div class="strength-bar"></div>
                    <span class="strength-text">密码强度：<span class="strength-value">弱</span></span>
                </div>
                {% if form.password.errors %}
                <div class="error-message">
                    {% for error in form.password.errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="confirm_password">确认新密码</label>
                <div class="password-input">
                    <input type="password" id="confirm_password" name="confirm_password" required
                           placeholder="请再次输入新密码">
                    <button type="button" class="toggle-password" onclick="togglePassword('confirm_password')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                {% if form.confirm_password.errors %}
                <div class="error-message">
                    {% for error in form.confirm_password.errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="password-requirements">
                <h4>密码要求</h4>
                <ul>
                    <li id="length" class="requirement">
                        <i class="fas fa-circle"></i>
                        至少8个字符
                    </li>
                    <li id="lowercase" class="requirement">
                        <i class="fas fa-circle"></i>
                        至少1个小写字母
                    </li>
                    <li id="uppercase" class="requirement">
                        <i class="fas fa-circle"></i>
                        至少1个大写字母
                    </li>
                    <li id="number" class="requirement">
                        <i class="fas fa-circle"></i>
                        至少1个数字
                    </li>
                    <li id="special" class="requirement">
                        <i class="fas fa-circle"></i>
                        至少1个特殊字符
                    </li>
                </ul>
            </div>

            <button type="submit" class="btn-primary btn-block">
                重置密码
            </button>
        </form>

        <!-- 安全提示 -->
        <div class="security-tips">
            <h3>安全提示</h3>
            <ul>
                <li>
                    <i class="fas fa-shield-alt"></i>
                    <span>请使用强密码保护您的账号安全</span>
                </li>
                <li>
                    <i class="fas fa-user-lock"></i>
                    <span>不要与其他网站使用相同的密码</span>
                </li>
                <li>
                    <i class="fas fa-key"></i>
                    <span>定期更换密码可以提高账号安全性</span>
                </li>
            </ul>
        </div>

        <!-- 返回登录 -->
        <div class="auth-footer">
            <p>密码已重置？ <a href="{{ url_for('auth.login') }}">返回登录</a></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/**
 * 切换密码显示/隐藏
 * @param {string} inputId - 密码输入框的ID
 */
function togglePassword(inputId) {
    const passwordInput = document.getElementById(inputId);
    const toggleButton = passwordInput.parentElement.querySelector('.toggle-password i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.classList.remove('fa-eye');
        toggleButton.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        toggleButton.classList.remove('fa-eye-slash');
        toggleButton.classList.add('fa-eye');
    }
}

/**
 * 检查密码强度
 */
document.getElementById('password').addEventListener('input', function(e) {
    const password = e.target.value;
    checkPasswordRequirements(password);
    updatePasswordStrength(password);
});

/**
 * 检查密码要求
 * @param {string} password - 密码
 */
function checkPasswordRequirements(password) {
    const requirements = {
        length: password.length >= 8,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^a-zA-Z0-9]/.test(password)
    };
    
    Object.entries(requirements).forEach(([key, met]) => {
        const element = document.getElementById(key);
        if (met) {
            element.classList.add('met');
        } else {
            element.classList.remove('met');
        }
    });
    
    return Object.values(requirements).filter(Boolean).length;
}

/**
 * 更新密码强度显示
 * @param {string} password - 密码
 */
function updatePasswordStrength(password) {
    const strength = checkPasswordRequirements(password);
    const strengthBar = document.querySelector('.strength-bar');
    const strengthValue = document.querySelector('.strength-value');
    
    let strengthClass = '';
    let strengthText = '';
    
    switch(strength) {
        case 0:
        case 1:
            strengthClass = 'weak';
            strengthText = '弱';
            break;
        case 2:
        case 3:
            strengthClass = 'medium';
            strengthText = '中';
            break;
        case 4:
            strengthClass = 'strong';
            strengthText = '强';
            break;
        case 5:
            strengthClass = 'very-strong';
            strengthText = '很强';
            break;
    }
    
    strengthBar.className = 'strength-bar ' + strengthClass;
    strengthValue.textContent = strengthText;
}

/**
 * 表单验证
 */
document.querySelector('.auth-form').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (password !== confirmPassword) {
        e.preventDefault();
        showAlert('两次输入的密码不一致', 'error');
        return;
    }
    
    if (checkPasswordRequirements(password) < 3) {
        e.preventDefault();
        showAlert('密码不符合安全要求', 'error');
        return;
    }
    
    // 显示加载状态
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 重置中...';
    
    // 提交后恢复按钮状态
    this.addEventListener('submit', () => {
        setTimeout(() => {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }, 2000);
    });
});
</script>
{% endblock %}

{% block styles %}
<style>
/* 密码要求样式 */
.password-requirements {
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
}

.password-requirements h4 {
    margin: 0 0 1rem;
    color: var(--text-primary);
    font-size: 1rem;
}

.password-requirements ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.requirement {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
    transition: color 0.3s ease;
}

.requirement i {
    font-size: 0.5rem;
    transition: color 0.3s ease;
}

.requirement.met {
    color: var(--success);
}

.requirement.met i {
    color: var(--success);
}

/* 安全提示样式 */
.security-tips {
    margin: 2rem 0;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
}

.security-tips h3 {
    margin: 0 0 1rem;
    color: var(--text-primary);
    font-size: 1.1rem;
}

.security-tips ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.security-tips li {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
}

.security-tips i {
    color: var(--primary);
    font-size: 1.2rem;
}

.security-tips span {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

/* 加载动画 */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.fa-spin {
    animation: spin 1s linear infinite;
}

/* 响应式调整 */
@media (max-width: 480px) {
    .security-tips li {
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
}
</style>
{% endblock %} 