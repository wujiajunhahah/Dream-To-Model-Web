{% extends "base.html" %}

{% block title %}API文档 - 梦境建模系统{% endblock %}

{% block content %}
<div class="api-docs">
    <!-- 侧边栏导航 -->
    <div class="api-sidebar">
        <div class="api-nav">
            <h3>目录</h3>
            <ul>
                <li><a href="#overview">概述</a></li>
                <li><a href="#authentication">认证</a></li>
                <li><a href="#endpoints">API端点</a></li>
                <li><a href="#models">模型相关</a></li>
                <li><a href="#users">用户相关</a></li>
                <li><a href="#examples">示例代码</a></li>
                <li><a href="#rate-limits">速率限制</a></li>
                <li><a href="#errors">错误处理</a></li>
            </ul>
        </div>
    </div>

    <!-- 主要内容区 -->
    <div class="api-content">
        <!-- 概述部分 -->
        <section id="overview" class="api-section">
            <h2>API概述</h2>
            <p>梦境建模系统提供RESTful API，让您能够以编程方式访问系统的功能。所有API请求都需要通过HTTPS进行，并使用JSON格式进行数据交换。</p>
            
            <div class="api-info">
                <div class="info-item">
                    <h4>基础URL</h4>
                    <code>https://api.dream-to-model.com/v1</code>
                </div>
                <div class="info-item">
                    <h4>数据格式</h4>
                    <code>application/json</code>
                </div>
                <div class="info-item">
                    <h4>字符编码</h4>
                    <code>UTF-8</code>
                </div>
            </div>
        </section>

        <!-- 认证部分 -->
        <section id="authentication" class="api-section">
            <h2>认证</h2>
            <p>所有API请求都需要使用API密钥进行认证。您可以在设置页面生成和管理API密钥。</p>
            
            <div class="code-block">
                <div class="code-header">
                    <span>请求头示例</span>
                    <button class="copy-btn" onclick="copyCode('auth-header')">复制</button>
                </div>
                <pre id="auth-header"><code>Authorization: Bearer your_api_key_here</code></pre>
            </div>

            <div class="api-note">
                <h4>安全提示</h4>
                <ul>
                    <li>请妥善保管您的API密钥</li>
                    <li>不要将API密钥提交到版本控制系统</li>
                    <li>定期轮换API密钥</li>
                    <li>使用HTTPS进行所有API请求</li>
                </ul>
            </div>
        </section>

        <!-- API端点部分 -->
        <section id="endpoints" class="api-section">
            <h2>API端点</h2>
            
            <!-- 模型相关端点 -->
            <div class="endpoint-group">
                <h3>模型相关</h3>
                
                <div class="endpoint-item">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <code>/models</code>
                        <span class="description">获取模型列表</span>
                    </div>
                    
                    <div class="endpoint-details">
                        <h4>参数</h4>
                        <table class="params-table">
                            <thead>
                                <tr>
                                    <th>参数</th>
                                    <th>类型</th>
                                    <th>必填</th>
                                    <th>描述</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>page</td>
                                    <td>integer</td>
                                    <td>否</td>
                                    <td>页码，默认1</td>
                                </tr>
                                <tr>
                                    <td>per_page</td>
                                    <td>integer</td>
                                    <td>否</td>
                                    <td>每页数量，默认20</td>
                                </tr>
                                <tr>
                                    <td>category</td>
                                    <td>string</td>
                                    <td>否</td>
                                    <td>模型分类</td>
                                </tr>
                                <tr>
                                    <td>style</td>
                                    <td>string</td>
                                    <td>否</td>
                                    <td>模型风格</td>
                                </tr>
                            </tbody>
                        </table>

                        <h4>响应示例</h4>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode('models-response')">复制</button>
                            </div>
                            <pre id="models-response"><code>{
    "data": [
        {
            "id": "model_123",
            "title": "示例模型",
            "description": "这是一个示例模型",
            "category": "architecture",
            "style": "realistic",
            "created_at": "2024-03-20T10:00:00Z",
            "preview_url": "https://example.com/preview.glb"
        }
    ],
    "meta": {
        "current_page": 1,
        "total_pages": 10,
        "total_items": 200
    }
}</code></pre>
                        </div>
                    </div>
                </div>

                <div class="endpoint-item">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <code>/models</code>
                        <span class="description">创建新模型</span>
                    </div>
                    
                    <div class="endpoint-details">
                        <h4>请求体</h4>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode('create-model')">复制</button>
                            </div>
                            <pre id="create-model"><code>{
    "title": "新模型",
    "description": "模型描述",
    "category": "architecture",
    "style": "realistic",
    "dream_description": "详细的梦境描述",
    "options": {
        "texture": true,
        "rigging": false,
        "animation": false
    }
}</code></pre>
                        </div>

                        <h4>响应示例</h4>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode('create-model-response')">复制</button>
                            </div>
                            <pre id="create-model-response"><code>{
    "id": "model_123",
    "title": "新模型",
    "status": "processing",
    "created_at": "2024-03-20T10:00:00Z"
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 用户相关端点 -->
            <div class="endpoint-group">
                <h3>用户相关</h3>
                
                <div class="endpoint-item">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <code>/user/profile</code>
                        <span class="description">获取用户信息</span>
                    </div>
                    
                    <div class="endpoint-details">
                        <h4>响应示例</h4>
                        <div class="code-block">
                            <div class="code-header">
                                <span>JSON</span>
                                <button class="copy-btn" onclick="copyCode('user-profile')">复制</button>
                            </div>
                            <pre id="user-profile"><code>{
    "id": "user_123",
    "username": "example_user",
    "email": "user@example.com",
    "avatar_url": "https://example.com/avatar.jpg",
    "bio": "用户简介",
    "created_at": "2024-01-01T00:00:00Z",
    "stats": {
        "models_count": 10,
        "followers_count": 100,
        "following_count": 50
    }
}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 示例代码部分 -->
        <section id="examples" class="api-section">
            <h2>示例代码</h2>
            
            <div class="example-group">
                <h3>Python示例</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>Python</span>
                        <button class="copy-btn" onclick="copyCode('python-example')">复制</button>
                    </div>
                    <pre id="python-example"><code>import requests

API_KEY = "your_api_key_here"
BASE_URL = "https://api.dream-to-model.com/v1"

# 创建模型
def create_model(title, description, category, style):
    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json"
    }
    
    data = {
        "title": title,
        "description": description,
        "category": category,
        "style": style,
        "dream_description": "详细的梦境描述",
        "options": {
            "texture": True,
            "rigging": False,
            "animation": False
        }
    }
    
    response = requests.post(
        f"{BASE_URL}/models",
        headers=headers,
        json=data
    )
    
    return response.json()

# 获取模型列表
def get_models(page=1, per_page=20):
    headers = {
        "Authorization": f"Bearer {API_KEY}"
    }
    
    params = {
        "page": page,
        "per_page": per_page
    }
    
    response = requests.get(
        f"{BASE_URL}/models",
        headers=headers,
        params=params
    )
    
    return response.json()</code></pre>
                </div>
            </div>

            <div class="example-group">
                <h3>JavaScript示例</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>JavaScript</span>
                        <button class="copy-btn" onclick="copyCode('javascript-example')">复制</button>
                    </div>
                    <pre id="javascript-example"><code>const API_KEY = "your_api_key_here";
const BASE_URL = "https://api.dream-to-model.com/v1";

// 创建模型
async function createModel(title, description, category, style) {
    const response = await fetch(`${BASE_URL}/models`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            title,
            description,
            category,
            style,
            dream_description: "详细的梦境描述",
            options: {
                texture: true,
                rigging: false,
                animation: false
            }
        })
    });
    
    return await response.json();
}

// 获取模型列表
async function getModels(page = 1, perPage = 20) {
    const response = await fetch(
        `${BASE_URL}/models?page=${page}&per_page=${perPage}`,
        {
            headers: {
                "Authorization": `Bearer ${API_KEY}`
            }
        }
    );
    
    return await response.json();
}</code></pre>
                </div>
            </div>
        </section>

        <!-- 速率限制部分 -->
        <section id="rate-limits" class="api-section">
            <h2>速率限制</h2>
            <p>API请求受到速率限制，以确保服务的稳定性和公平性。</p>
            
            <div class="rate-limits-table">
                <table>
                    <thead>
                        <tr>
                            <th>端点</th>
                            <th>限制</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>所有端点</td>
                            <td>100次/分钟</td>
                            <td>基础速率限制</td>
                        </tr>
                        <tr>
                            <td>/models (POST)</td>
                            <td>10次/小时</td>
                            <td>模型创建限制</td>
                        </tr>
                        <tr>
                            <td>/models (GET)</td>
                            <td>1000次/小时</td>
                            <td>模型查询限制</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="api-note">
                <h4>速率限制响应</h4>
                <p>当超过速率限制时，API将返回429状态码和以下响应：</p>
                <div class="code-block">
                    <div class="code-header">
                        <span>JSON</span>
                        <button class="copy-btn" onclick="copyCode('rate-limit-response')">复制</button>
                    </div>
                    <pre id="rate-limit-response"><code>{
    "error": "rate_limit_exceeded",
    "message": "请求过于频繁，请稍后再试",
    "retry_after": 60
}</code></pre>
                </div>
            </div>
        </section>

        <!-- 错误处理部分 -->
        <section id="errors" class="api-section">
            <h2>错误处理</h2>
            <p>API使用标准的HTTP状态码和统一的错误响应格式。</p>
            
            <div class="error-codes">
                <h3>常见错误码</h3>
                <table>
                    <thead>
                        <tr>
                            <th>状态码</th>
                            <th>说明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>400</td>
                            <td>请求参数错误</td>
                        </tr>
                        <tr>
                            <td>401</td>
                            <td>未认证或认证失败</td>
                        </tr>
                        <tr>
                            <td>403</td>
                            <td>权限不足</td>
                        </tr>
                        <tr>
                            <td>404</td>
                            <td>资源不存在</td>
                        </tr>
                        <tr>
                            <td>429</td>
                            <td>请求过于频繁</td>
                        </tr>
                        <tr>
                            <td>500</td>
                            <td>服务器内部错误</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="error-response">
                <h3>错误响应格式</h3>
                <div class="code-block">
                    <div class="code-header">
                        <span>JSON</span>
                        <button class="copy-btn" onclick="copyCode('error-response')">复制</button>
                    </div>
                    <pre id="error-response"><code>{
    "error": "error_code",
    "message": "错误描述信息",
    "details": {
        "field": "具体错误字段",
        "reason": "错误原因"
    }
}</code></pre>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/**
 * 复制代码到剪贴板
 * @param {string} elementId - 要复制的代码元素的ID
 */
function copyCode(elementId) {
    const codeElement = document.getElementById(elementId);
    const code = codeElement.textContent;
    
    navigator.clipboard.writeText(code).then(() => {
        // 显示复制成功提示
        const button = codeElement.parentElement.querySelector('.copy-btn');
        const originalText = button.textContent;
        button.textContent = '已复制';
        
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    }).catch(err => {
        console.error('复制失败:', err);
    });
}

// 平滑滚动
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});

// 代码块语法高亮
document.querySelectorAll('pre code').forEach((block) => {
    block.classList.add('language-json');
    hljs.highlightBlock(block);
});
</script>
{% endblock %} 