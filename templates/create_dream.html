{% extends "base.html" %}

{% block title %}创建梦境 - DreamEcho{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="container mx-auto px-4 pt-12 pb-8">
    <div class="max-w-4xl mx-auto text-center">
        <!-- Breadcrumb -->
        <div class="flex items-center justify-center mb-8 text-sm text-muted-foreground animate-slide-down">
            <a href="{{ url_for('index') }}" class="hover:text-foreground transition-colors">首页</a>
            <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
            <span class="text-foreground">创建梦境</span>
        </div>
        
        <!-- Title -->
        <div class="animate-slide-up">
            <h1 class="text-5xl md:text-6xl font-light mb-6 tracking-tight">
                <span class="text-gradient-dreamecho font-medium">创建你的梦境</span>
            </h1>
            <p class="text-xl text-muted-foreground mb-12 max-w-2xl mx-auto">
                描述你的梦境，让AI为你创造独特的3D艺术作品
            </p>
        </div>
    </div>
</section>

<!-- Main Form Section -->
<section class="container mx-auto px-4 pb-24">
    <div class="max-w-4xl mx-auto">
        <form id="dreamForm" class="space-y-8 animate-fade-in" method="POST" action="{{ url_for('create_dream_api') }}">
            <!-- Dream Title -->
            <div class="glass rounded-2xl p-8 border border-primary/20 hover:border-primary/40 transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-primary to-dreamecho-accent flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-foreground">梦境标题</h2>
                </div>
                <input type="text" id="title" name="title" 
                       class="w-full px-4 py-3 bg-background/50 border border-border rounded-xl text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                       placeholder="给你的梦境起个名字..." required>
            </div>

            <!-- Dream Description -->
            <div class="glass rounded-2xl p-8 border border-primary/20 hover:border-primary/40 transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-primary to-dreamecho-accent flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-foreground">梦境描述</h2>
                </div>
                <textarea id="description" name="description" rows="6"
                          class="w-full px-4 py-3 bg-background/50 border border-border rounded-xl text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300 resize-none" 
                          placeholder="详细描述你的梦境...&#10;&#10;例如：我梦见自己在一个漂浮的城市中飞行，周围有彩色的云朵和发光的建筑物..." 
                          required></textarea>
                <div class="flex justify-between items-center mt-4">
                    <div class="text-sm text-muted-foreground">
                        <span id="charCount">0</span> / 500 字符
                    </div>
                    <button type="button" class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-primary to-dreamecho-accent rounded-full hover:opacity-90 transition-all duration-300 hover:scale-105 transform" onclick="generateTags()">
                        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        AI生成标签
                    </button>
                </div>
            </div>

            <!-- Tags -->
            <div class="glass rounded-2xl p-8 border border-primary/20 hover:border-primary/40 transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-primary to-dreamecho-accent flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-foreground">标签 (可选)</h2>
                </div>
                <input type="text" id="tags" name="tags" 
                       class="w-full px-4 py-3 bg-background/50 border border-border rounded-xl text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                       placeholder="输入标签，用逗号分隔...">
                <div class="mt-4" id="tagsPreview"></div>
            </div>

            <!-- Blockchain Selection -->
            <div class="glass rounded-2xl p-8 border border-primary/20 hover:border-primary/40 transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-primary to-dreamecho-accent flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-foreground">选择区块链</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Ethereum -->
                    <label class="relative cursor-pointer group">
                        <input type="radio" name="blockchain" value="ethereum" checked class="sr-only">
                        <div class="glass rounded-xl p-6 border border-border group-hover:border-primary/40 transition-all duration-300 group-hover:scale-105 transform">
                            <div class="flex items-center space-x-4">
                                <img src="{{ url_for('static', filename='images/Ethereum.png') }}" alt="Ethereum" class="w-12 h-12 rounded-full">
                                <div>
                                    <div class="font-semibold text-foreground">Ethereum</div>
                                    <div class="text-sm text-muted-foreground">Gas费: ~$15</div>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- Polygon -->
                    <label class="relative cursor-pointer group">
                        <input type="radio" name="blockchain" value="polygon" class="sr-only">
                        <div class="glass rounded-xl p-6 border border-border group-hover:border-primary/40 transition-all duration-300 group-hover:scale-105 transform">
                            <div class="flex items-center space-x-4">
                                <img src="{{ url_for('static', filename='images/feature1.jpg') }}" alt="Polygon" class="w-12 h-12 rounded-full">
                                <div>
                                    <div class="font-semibold text-foreground">Polygon</div>
                                    <div class="text-sm text-muted-foreground">Gas费: ~$0.1</div>
                                </div>
                            </div>
                        </div>
                    </label>

                    <!-- BSC -->
                    <label class="relative cursor-pointer group">
                        <input type="radio" name="blockchain" value="bsc" class="sr-only">
                        <div class="glass rounded-xl p-6 border border-border group-hover:border-primary/40 transition-all duration-300 group-hover:scale-105 transform">
                            <div class="flex items-center space-x-4">
                                <img src="{{ url_for('static', filename='images/BSC.png') }}" alt="BSC" class="w-12 h-12 rounded-full">
                                <div>
                                    <div class="font-semibold text-foreground">BSC</div>
                                    <div class="text-sm text-muted-foreground">Gas费: ~$0.2</div>
                                </div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Trading Settings -->
            <div class="glass rounded-2xl p-8 border border-primary/20 hover:border-primary/40 transition-all duration-300">
                <div class="flex items-center mb-6">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-r from-primary to-dreamecho-accent flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-semibold text-foreground">交易设置</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Price -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">初始价格</label>
                        <div class="flex">
                            <input type="number" id="price" name="price" step="0.001" min="0"
                                   class="flex-1 px-4 py-3 bg-background/50 border border-border rounded-l-xl text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                   placeholder="0.01">
                            <select id="currency" name="currency" 
                                    class="px-4 py-3 bg-background/50 border border-l-0 border-border rounded-r-xl text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                <option value="ETH">ETH</option>
                                <option value="MATIC">MATIC</option>
                                <option value="BNB">BNB</option>
                            </select>
                        </div>
                    </div>

                    <!-- Royalty -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">版税 (%)</label>
                        <input type="number" id="royalty" name="royalty" step="0.1" min="0" max="10" value="2.5"
                               class="w-full px-4 py-3 bg-background/50 border border-border rounded-xl text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                               placeholder="2.5">
                    </div>

                    <!-- Trading Type -->
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">交易类型</label>
                        <select id="tradingType" name="tradingType" 
                                class="w-full px-4 py-3 bg-background/50 border border-border rounded-xl text-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                            <option value="fixed">固定价格</option>
                            <option value="auction">拍卖</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center pt-8">
                <button type="submit" id="createBtn" 
                        class="px-12 py-4 text-lg font-semibold text-white button-gradient-dreamecho rounded-full hover:scale-105 transform transition-all duration-300 shadow-lg hover:shadow-primary/25 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <span class="btn-content flex items-center justify-center">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        开始创建梦境
                    </span>
                    <div class="btn-loading hidden">
                        <svg class="w-6 h-6 mr-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        正在创建...
                    </div>
                </button>
            </div>
        </form>
    </div>
</section>

<!-- Progress Modal -->
<div id="progressModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
    <div class="glass rounded-2xl p-8 max-w-md w-full mx-4 border border-primary/20">
        <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-r from-primary to-dreamecho-accent flex items-center justify-center animate-glow">
                <svg class="w-8 h-8 text-white animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-semibold text-foreground mb-4">正在创建你的梦境...</h3>
            
            <!-- Progress Bar -->
            <div class="mb-4">
                <div class="w-full bg-background/50 rounded-full h-3 overflow-hidden">
                    <div id="progressFill" class="h-full bg-gradient-to-r from-primary to-dreamecho-accent transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span id="progressText" class="text-sm text-muted-foreground">0%</span>
                    <span id="progressTime" class="text-sm text-muted-foreground">预计剩余时间: --</span>
                </div>
            </div>
            
            <div id="progressStage" class="text-lg text-foreground mb-2">准备中...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Character counter
document.getElementById('description').addEventListener('input', function() {
    const charCount = this.value.length;
    document.getElementById('charCount').textContent = charCount;
    
    if (charCount > 500) {
        this.value = this.value.substring(0, 500);
        document.getElementById('charCount').textContent = 500;
    }
});

// Blockchain selection
document.querySelectorAll('input[name="blockchain"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // Remove selected state from all options
        document.querySelectorAll('input[name="blockchain"]').forEach(r => {
            r.closest('label').querySelector('div').classList.remove('border-primary', 'bg-primary/10');
        });
        
        // Add selected state to current option
        if (this.checked) {
            this.closest('label').querySelector('div').classList.add('border-primary', 'bg-primary/10');
        }
    });
});

// Initialize first blockchain option as selected
document.querySelector('input[name="blockchain"]:checked').closest('label').querySelector('div').classList.add('border-primary', 'bg-primary/10');

// AI Tag Generation
function generateTags() {
    const description = document.getElementById('description').value;
    if (!description.trim()) {
        alert('请先输入梦境描述');
        return;
    }
    
    // Simulate AI tag generation
    const sampleTags = ['梦幻', '超现实', '科幻', '奇幻', '抽象', '色彩斑斓', '神秘', '未来主义'];
    const randomTags = sampleTags.sort(() => 0.5 - Math.random()).slice(0, 3);
    document.getElementById('tags').value = randomTags.join(', ');
    updateTagsPreview();
}

// Tags preview
function updateTagsPreview() {
    const tags = document.getElementById('tags').value;
    const preview = document.getElementById('tagsPreview');
    
    if (tags.trim()) {
        const tagArray = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
        preview.innerHTML = tagArray.map(tag => 
            `<span class="inline-block px-3 py-1 bg-primary/20 text-primary rounded-full text-sm mr-2 mb-2">${tag}</span>`
        ).join('');
    } else {
        preview.innerHTML = '';
    }
}

document.getElementById('tags').addEventListener('input', updateTagsPreview);

// Form submission
document.getElementById('dreamForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const createBtn = document.getElementById('createBtn');
    const progressModal = document.getElementById('progressModal');
    
    // Show loading state
    createBtn.querySelector('.btn-content').classList.add('hidden');
    createBtn.querySelector('.btn-loading').classList.remove('hidden');
    createBtn.disabled = true;
    
    // Show progress modal
    progressModal.classList.remove('hidden');
    
    // Simulate progress
    let progress = 0;
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressStage = document.getElementById('progressStage');
    const progressTime = document.getElementById('progressTime');
    
    const stages = [
        '分析梦境描述...',
        '生成3D模型...',
        '优化模型质量...',
        '创建NFT元数据...',
        '上传到区块链...',
        '完成创建！'
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressFill.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        const stageIndex = Math.floor((progress / 100) * stages.length);
        if (stageIndex < stages.length) {
            progressStage.textContent = stages[stageIndex];
        }
        
        const remainingTime = Math.max(0, Math.round((100 - progress) / 10));
        progressTime.textContent = `预计剩余时间: ${remainingTime}秒`;
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                // Submit the actual form
                this.submit();
            }, 1000);
        }
    }, 500);
});

// Animation on scroll
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
        }
    });
}, observerOptions);

document.addEventListener('DOMContentLoaded', () => {
    const animatedElements = document.querySelectorAll('.animate-fade-in');
    animatedElements.forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
    });
});
</script>
{% endblock %} 