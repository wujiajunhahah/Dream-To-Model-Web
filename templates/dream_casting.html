{% extends "base.html" %}

{% block title %}梦境铸造 - 创建您的3D模型{% endblock %}

{% block extra_head %}
<style>
    .dream-form {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }

    .form-group textarea {
        width: 100%;
        min-height: 200px;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        line-height: 1.6;
    }

    .submit-button {
        background: var(--primary-color);
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s ease;
    }

    .submit-button:hover {
        background: var(--secondary-color);
    }

    .loading {
        display: none;
        text-align: center;
        margin: 2rem 0;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .result-section {
        display: none;
        margin-top: 2rem;
        padding: 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .model-preview {
        width: 100%;
        height: 400px;
        margin: 1rem 0;
    }

    .interpretation {
        margin: 1rem 0;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 5px;
    }

    .download-section {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .download-button {
        background: var(--secondary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        text-decoration: none;
        transition: background 0.3s ease;
    }

    .download-button:hover {
        background: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="dream-form">
    <h2>描述您的梦境</h2>
    <form id="dreamForm">
        <div class="form-group">
            <label for="dream_text">请详细描述您的梦境内容：</label>
            <textarea id="dream_text" name="dream_text" required
                      placeholder="请尽可能详细地描述您的梦境，包括：
- 场景和环境
- 人物和角色
- 情感和感受
- 特殊的事件或情节
- 任何重要的细节"></textarea>
        </div>
        <button type="submit" class="submit-button">开始铸造</button>
    </form>

    <div class="loading">
        <div class="loading-spinner"></div>
        <p>正在分析您的梦境并生成3D模型，这可能需要几分钟时间...</p>
    </div>

    <div class="result-section">
        <h3>您的梦境模型已生成</h3>
        <div class="model-preview">
            <model-viewer
                id="modelViewer"
                auto-rotate
                camera-controls
                shadow-intensity="1"
            ></model-viewer>
        </div>
        <div class="interpretation">
            <h4>梦境解析</h4>
            <div id="interpretationContent"></div>
        </div>
        <div class="download-section">
            <a href="#" id="downloadModel" class="download-button">下载3D模型</a>
            <a href="#" id="downloadInterpretation" class="download-button">下载解析报告</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('dreamForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const loading = document.querySelector('.loading');
    const resultSection = document.querySelector('.result-section');
    const modelViewer = document.getElementById('modelViewer');
    const interpretationContent = document.getElementById('interpretationContent');
    const downloadModel = document.getElementById('downloadModel');
    const downloadInterpretation = document.getElementById('downloadInterpretation');
    
    // 显示加载动画
    loading.style.display = 'block';
    resultSection.style.display = 'none';
    
    try {
        const response = await fetch('{{ url_for("dream_casting") }}', {
            method: 'POST',
            body: new FormData(form)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 更新模型预览
            modelViewer.src = data.model_file;
            
            // 获取并显示解析内容
            const interpretationResponse = await fetch(data.interpretation_file);
            const interpretationText = await interpretationResponse.text();
            interpretationContent.innerHTML = interpretationText.replace(/\n/g, '<br>');
            
            // 设置下载链接
            downloadModel.href = data.model_file;
            downloadInterpretation.href = data.interpretation_file;
            
            // 显示结果
            loading.style.display = 'none';
            resultSection.style.display = 'block';
        } else {
            alert('生成模型失败：' + data.error);
            loading.style.display = 'none';
        }
    } catch (error) {
        alert('发生错误：' + error.message);
        loading.style.display = 'none';
    }
});
</script>
{% endblock %} 